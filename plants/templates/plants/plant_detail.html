{% extends 'plants/base.html' %}

{% block title %}{{ plant.name|default:"Plant" }} - Plant Tracker{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-8">
    <div class="flex justify-between items-start mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ plant.name|default:"Unnamed Plant" }}</h1>
            {% if plant.scientific_name %}
                <p class="text-xl text-gray-600 italic">{{ plant.scientific_name.scientific_name }}</p>
            {% else %}
                <p class="text-xl text-gray-500">No scientific name assigned</p>
            {% endif %}
        </div>
        <div class="flex space-x-3">
            <a href="{% url 'plant-update' plant.pk %}" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200">
                Edit Plant
            </a>
            <a href="{% url 'plant-delete' plant.pk %}" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200">
                Delete Plant
            </a>
        </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
        <div>
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Plant Information</h2>
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Plant ID</label>
                    <p class="text-gray-900">{{ plant.id }}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <p class="text-gray-900">{{ plant.name|default:"Not specified" }}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Scientific Name</label>
                    {% if plant.scientific_name %}
                        <p class="text-gray-900 italic">{{ plant.scientific_name.scientific_name }}</p>
                    {% else %}
                        <p class="text-gray-500">Not specified</p>
                    {% endif %}
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    {% if plant.notes %}
                        <p class="text-gray-900 whitespace-pre-wrap">{{ plant.notes }}</p>
                    {% else %}
                        <p class="text-gray-500">No notes added</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div>
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Health Status</h2>
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Current Health</label>
                {% if latest_health_status %}
                    <p class="text-lg font-medium mb-1">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if latest_health_status.health_status == 'thriving' %}bg-green-100 text-green-800
                            {% elif latest_health_status.health_status == 'healthy' %}bg-blue-100 text-blue-800
                            {% elif latest_health_status.health_status == 'improving' %}bg-yellow-100 text-yellow-800
                            {% elif latest_health_status.health_status == 'bad' %}bg-orange-100 text-orange-800
                            {% elif latest_health_status.health_status == 'worsening' %}bg-red-100 text-red-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ latest_health_status.get_health_status_display|title }}
                        </span>
                    </p>
                    <p class="text-sm text-gray-500">{{ latest_health_status.datetime|date:"F d, Y \a\t g:i A" }}</p>
                {% else %}
                    <p class="text-gray-500 italic">No health status recorded</p>
                {% endif %}
            </div>

            <h3 class="text-lg font-medium text-gray-900 mb-3">Plant Care</h3>
            <div class="space-y-2 mb-4">
                <button onclick="openHealthModal()" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition duration-200">
                    üå± Update Health Status
                </button>
                <button onclick="openEventModal()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition duration-200">
                    üìù Log Care Event
                </button>
                <button onclick="openImageModal()" class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition duration-200">
                    üì∑ Upload Image
                </button>
            </div>

        </div>
    </div>

    <!-- Plant Images -->
    <div class="mt-8 pt-8 border-t border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Plant Images</h2>
        {% if images %}
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                {% for image in images %}
                <div class="bg-white rounded-lg shadow-md overflow-hidden group">
                    <div class="relative">
                        <img src="/media/{{ image.image_path }}" alt="Plant image" class="w-full h-48 object-cover">
                        <!-- Edit/Delete buttons overlay -->
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                            <div class="flex space-x-1">
                                <a href="{% url 'image-update' image.pk %}" 
                                   class="bg-blue-500 hover:bg-blue-600 text-white p-1 rounded-full shadow-lg transition duration-200"
                                   title="Edit caption">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </a>
                                <a href="{% url 'image-delete' image.pk %}" 
                                   class="bg-red-500 hover:bg-red-600 text-white p-1 rounded-full shadow-lg transition duration-200"
                                   title="Delete image">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>
                    {% if image.caption %}
                    <div class="p-3">
                        <p class="text-sm text-gray-600">{{ image.caption }}</p>
                    </div>
                    {% endif %}
                    <div class="px-3 pb-3">
                        <p class="text-xs text-gray-500">{{ image.uploaded_at|date:"M d, Y" }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-8 bg-gray-50 rounded-lg">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
                <p class="text-gray-500 mt-2">No images uploaded yet</p>
                <p class="text-sm text-gray-400">Click "Upload Image" to add your first photo</p>
            </div>
        {% endif %}
    </div>

    <!-- Recent Events and Health History -->
    <div class="mt-8 pt-8 border-t border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Recent Activity</h2>
        <div class="grid md:grid-cols-2 gap-6">
            <div>
                <h3 class="text-lg font-medium text-gray-900 mb-3">Recent Events</h3>
                {% if recent_events %}
                    <div class="space-y-3">
                        {% for event in recent_events %}
                        <div class="bg-gray-50 p-3 rounded-lg group">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-gray-900">{{ event.get_event_type_display|title }}</span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-gray-500">{{ event.datetime|date:"M d, Y" }}</span>
                                    <a href="{% url 'event-delete' event.pk %}" 
                                       class="opacity-0 group-hover:opacity-100 text-red-600 hover:text-red-700 p-1 transition-all duration-200"
                                       title="Delete event"
                                       aria-label="Delete event">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                            {% if event.comments %}
                                <p class="text-sm text-gray-600 mt-1">{{ event.comments }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-500 italic">No events recorded yet</p>
                {% endif %}
            </div>
            
            <div>
                <h3 class="text-lg font-medium text-gray-900 mb-3">Health History</h3>
                {% if plant.health_checkins.all %}
                    <div class="space-y-3">
                        {% for health_checkin in plant.health_checkins.all|slice:":5" %}
                        <div class="bg-gray-50 p-3 rounded-lg group">
                            <div class="flex items-center justify-between">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if health_checkin.health_status == 'thriving' %}bg-green-100 text-green-800
                                    {% elif health_checkin.health_status == 'healthy' %}bg-blue-100 text-blue-800
                                    {% elif health_checkin.health_status == 'improving' %}bg-yellow-100 text-yellow-800
                                    {% elif health_checkin.health_status == 'bad' %}bg-orange-100 text-orange-800
                                    {% elif health_checkin.health_status == 'worsening' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ health_checkin.get_health_status_display|title }}
                                </span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-gray-500">{{ health_checkin.datetime|date:"M d, Y" }}</span>
                                    <a href="{% url 'health-checkin-delete' health_checkin.pk %}" 
                                       class="opacity-0 group-hover:opacity-100 text-red-600 hover:text-red-700 p-1 transition-all duration-200"
                                       title="Delete health check-in"
                                       aria-label="Delete health check-in">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                            {% if health_checkin.comments %}
                                <p class="text-sm text-gray-600 mt-1">{{ health_checkin.comments }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-500 italic">No health check-ins recorded yet</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Health Status Modal -->
<div id="healthModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">Update Health Status</h3>
            <div class="grid grid-cols-2 gap-2 mb-4" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                <button hx-post="{% url 'quick-health-update' plant.pk %}" 
                        hx-vals='{"health_status": "thriving"}'
                        hx-swap="none"
                        hx-on::after-request="if(event.detail.successful) { closeHealthModal(); window.location.reload(); }"
                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 text-sm rounded-md transition duration-200">
                    Thriving
                </button>
                <button hx-post="{% url 'quick-health-update' plant.pk %}" 
                        hx-vals='{"health_status": "healthy"}'
                        hx-swap="none"
                        hx-on::after-request="if(event.detail.successful) { closeHealthModal(); window.location.reload(); }"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 text-sm rounded-md transition duration-200">
                    Healthy
                </button>
                <button hx-post="{% url 'quick-health-update' plant.pk %}" 
                        hx-vals='{"health_status": "improving"}'
                        hx-swap="none"
                        hx-on::after-request="if(event.detail.successful) { closeHealthModal(); window.location.reload(); }"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 text-sm rounded-md transition duration-200">
                    Improving
                </button>
                <button hx-post="{% url 'quick-health-update' plant.pk %}" 
                        hx-vals='{"health_status": "bad"}'
                        hx-swap="none"
                        hx-on::after-request="if(event.detail.successful) { closeHealthModal(); window.location.reload(); }"
                        class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 text-sm rounded-md transition duration-200">
                    Bad
                </button>
                <button hx-post="{% url 'quick-health-update' plant.pk %}" 
                        hx-vals='{"health_status": "worsening"}'
                        hx-swap="none"
                        hx-on::after-request="if(event.detail.successful) { closeHealthModal(); window.location.reload(); }"
                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 text-sm rounded-md transition duration-200">
                    Worsening
                </button>
                <button hx-post="{% url 'quick-health-update' plant.pk %}" 
                        hx-vals='{"health_status": "dead"}'
                        hx-swap="none"
                        hx-on::after-request="if(event.detail.successful) { closeHealthModal(); window.location.reload(); }"
                        class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 text-sm rounded-md transition duration-200">
                    Dead
                </button>
            </div>
            <div class="flex justify-center mt-6">
                <button type="button" onclick="closeHealthModal()" 
                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Event Modal -->
<div id="eventModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">Log Care Event</h3>
            
            <!-- Event Type Selection -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 text-left mb-2">Event Type</label>
                <div class="grid grid-cols-2 gap-2">
                    <button type="button" onclick="selectEventType('watering', 'üíß Watering')" 
                        class="event-type-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 text-sm rounded-md transition duration-200">
                        üíß Watering
                    </button>
                    <button type="button" onclick="selectEventType('repot', 'ü™¥ Repot')" 
                        class="event-type-btn bg-amber-500 hover:bg-amber-600 text-white px-3 py-2 text-sm rounded-md transition duration-200">
                        ü™¥ Repot
                    </button>
                    <button type="button" onclick="selectEventType('environment change', 'üå°Ô∏è Environment')" 
                        class="event-type-btn bg-green-500 hover:bg-green-600 text-white px-3 py-2 text-sm rounded-md transition duration-200">
                        üå°Ô∏è Environment
                    </button>
                    <button type="button" onclick="selectEventType('cuttings', '‚úÇÔ∏è Cuttings')" 
                        class="event-type-btn bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 text-sm rounded-md transition duration-200">
                        ‚úÇÔ∏è Cuttings
                    </button>
                </div>
            </div>

            <!-- Event Form (hidden until event type selected) -->
            <form id="eventForm" hx-post="{% url 'create-event' plant.pk %}" hx-swap="none" hx-on::after-request="handleEventResponse(event)" class="hidden">
                {% csrf_token %}
                <input type="hidden" id="eventType" name="event_type" value="">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 text-left mb-2">
                        <span id="selectedEventType">Event</span> - Comments (optional)
                    </label>
                    <textarea 
                        id="eventComments" 
                        name="comments" 
                        rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                        placeholder="Optional notes about this event..."></textarea>
                </div>
                <div class="flex justify-center space-x-3">
                    <button type="button" onclick="showEventSelection()" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200">
                        Back
                    </button>
                    <button type="submit" 
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition duration-200">
                        Log Event
                    </button>
                </div>
            </form>
            
            <!-- Cancel button for event type selection -->
            <div id="eventCancelButton" class="flex justify-center mt-6">
                <button type="button" onclick="closeEventModal()" 
                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Image Upload Modal -->
<div id="imageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">Upload Plant Image</h3>
            
            <form hx-post="{% url 'upload-plant-image' plant.pk %}" 
                  hx-encoding="multipart/form-data"
                  hx-swap="none"
                  hx-on::after-request="handleImageUpload(event)"
                  class="space-y-4">
                {% csrf_token %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-left mb-2">Select Image</label>
                    <input type="file" name="image_file" accept="image/*" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 text-left mb-2">Caption (optional)</label>
                    <textarea name="caption" rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                        placeholder="Optional caption for the image..."></textarea>
                </div>
                
                <div class="flex justify-center space-x-3 pt-4">
                    <button type="button" onclick="closeImageModal()" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" 
                        class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition duration-200">
                        Upload Image
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Health Modal Functions
function openHealthModal() {
    document.getElementById('healthModal').classList.remove('hidden');
}

function closeHealthModal() {
    document.getElementById('healthModal').classList.add('hidden');
}

// Event Modal Functions
function openEventModal() {
    document.getElementById('eventModal').classList.remove('hidden');
    showEventSelection();
}

function closeEventModal() {
    document.getElementById('eventModal').classList.add('hidden');
    document.getElementById('eventForm').reset();
    document.getElementById('eventForm').classList.add('hidden');
    document.getElementById('eventCancelButton').classList.remove('hidden');
    // Reset event type buttons
    document.querySelectorAll('.event-type-btn').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-offset-2', 'ring-gray-400');
    });
}

function showEventSelection() {
    document.getElementById('eventForm').classList.add('hidden');
    document.getElementById('eventCancelButton').classList.remove('hidden');
}

function selectEventType(eventType, displayName) {
    document.getElementById('eventType').value = eventType;
    document.getElementById('selectedEventType').textContent = displayName;
    document.getElementById('eventForm').classList.remove('hidden');
    document.getElementById('eventCancelButton').classList.add('hidden');
    document.getElementById('eventComments').focus();
    
    // Visual feedback for selected button
    document.querySelectorAll('.event-type-btn').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-offset-2', 'ring-gray-400');
    });
    event.target.classList.add('ring-2', 'ring-offset-2', 'ring-gray-400');
}

function handleEventResponse(event) {
    if (event.detail.successful) {
        closeEventModal();
        window.location.reload();
    }
}

// Image Modal Functions
function openImageModal() {
    document.getElementById('imageModal').classList.remove('hidden');
}

function closeImageModal() {
    document.getElementById('imageModal').classList.add('hidden');
    // Reset form
    const form = document.querySelector('#imageModal form');
    form.reset();
}

function handleImageUpload(event) {
    if (event.detail.successful) {
        closeImageModal();
        window.location.reload();
    } else {
        // Handle error - could show error message
        console.error('Image upload failed:', event.detail.xhr.responseText);
    }
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const healthModal = document.getElementById('healthModal');
    const eventModal = document.getElementById('eventModal');
    const imageModal = document.getElementById('imageModal');
    
    if (event.target == healthModal) {
        closeHealthModal();
    }
    if (event.target == eventModal) {
        closeEventModal();
    }
    if (event.target == imageModal) {
        closeImageModal();
    }
}
</script>
{% endblock %}